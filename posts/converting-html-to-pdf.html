<!DOCTYPE html><html><head><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-193041393-1"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-193041393-1', {
              page_path: window.location.pathname,
            });
          </script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"/><link rel="preload" href="/fonts/FiraCode-VariableFont_wght.ttf" as="font" crossorigin="anonymous"/><link rel="icon" href="data:image/svg+xml,&lt;svg xmlns=&#x27;http://www.w3.org/2000/svg&#x27; viewBox=&#x27;0 0 100 100&#x27;&gt;&lt;text y=&#x27;.9em&#x27; font-size=&#x27;90&#x27;&gt;üëã&lt;/text&gt;&lt;/svg&gt;"/><meta name="description" content="Building an AWS lambda function that uses Python and wkhtmltopdf to convert an HTML file to a PDF file."/><meta property="og:image" content="https://og-image.vercel.app/Converting%20HTML%20to%20a%20PDF%20using%20Python,%20AWS%20Lambda,%20and%20wkhtmltopdf.png?theme=light&amp;md=1&amp;fontSize=50px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fhyper-color-logo.svg&amp;widths=350&amp;heights=350"/><meta name="robots" content="follow, index"/><meta name="og:title" content="Converting HTML to a PDF using Python, AWS Lambda, and wkhtmltopdf"/><meta property="og:site_name" content="Converting HTML to a PDF using Python, AWS Lambda, and wkhtmltopdf"/><meta property="og:description" content="Building an AWS lambda function that uses Python and wkhtmltopdf to convert an HTML file to a PDF file."/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@bschoeneweis"/><meta name="twitter:title" content="Bradley Schoeneweis"/><meta name="twitter:description" content="Building an AWS lambda function that uses Python and wkhtmltopdf to convert an HTML file to a PDF file."/><meta name="twitter:image" content="https://og-image.vercel.app/Converting%20HTML%20to%20a%20PDF%20using%20Python,%20AWS%20Lambda,%20and%20wkhtmltopdf.png?theme=light&amp;md=1&amp;fontSize=50px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fhyper-color-logo.svg&amp;widths=350&amp;heights=350"/><title>Converting HTML to a PDF using Python, AWS Lambda, and wkhtmltopdf</title><meta name="next-head-count" content="17"/><link rel="preload" href="/_next/static/css/06dea8e0c799365a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/06dea8e0c799365a.css" data-n-g=""/><link rel="preload" href="/_next/static/css/3a133f7daa4dc1db.css" as="style"/><link rel="stylesheet" href="/_next/static/css/3a133f7daa4dc1db.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-41541f30921e7079.js" defer=""></script><script src="/_next/static/chunks/framework-7d488969745094b0.js" defer=""></script><script src="/_next/static/chunks/main-c3ed9a593ffd1a6c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d542c2ab22c8ff03.js" defer=""></script><script src="/_next/static/chunks/4824-86805e89d9bc00a3.js" defer=""></script><script src="/_next/static/chunks/494-a7f972c4001b17a3.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-7e1c7411c564526c.js" defer=""></script><script src="/_next/static/YR03i7rb3JyT9k3rOsHHa/_buildManifest.js" defer=""></script><script src="/_next/static/YR03i7rb3JyT9k3rOsHHa/_ssgManifest.js" defer=""></script><script src="/_next/static/YR03i7rb3JyT9k3rOsHHa/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="layout_ArticleContainer__QR4qB"><header><div class="layout_LayoutLinks__92rCe"><a href="/">‚Üê Back home</a></div></header><main><article><h1 class="utils_headingXl__u25Y2">Converting HTML to a PDF using Python, AWS Lambda, and wkhtmltopdf</h1><div class="tag_TagList__IWJKV tag_TagListPost__iMXoV"><div class="utils_displayFlex__VCtvW"><a href="/tags/python"><div><span class="tag_Badge__e6qwu utils_cursorPointer__oXutf">python</span></div></a></div><div class="utils_displayFlex__VCtvW"><a href="/tags/aws"><div><span class="tag_Badge__e6qwu utils_cursorPointer__oXutf">aws</span></div></a></div></div><div class="author_Author__QmrQi"><img loading="eager" src="/images/profile.jpg" height="40" width="40" alt="Bradley Schoeneweis" class="utils_borderCircle__s2nTm author_AuthorImage__6NLD6"/><div class="utils_lightText__eUzGY author_AuthorDate__HzPM6">Bradley Schoeneweis<span class="utils_dotSeparator__Ij4lk">‚Ä¢</span><time dateTime="2021-04-29">April 29, 2021</time></div></div><h2>tl;dr</h2>
<h3>Goal</h3>
<p><em>To set up an easy to call HTML to PDF converter as an AWS Lambda function.</em></p>
<h3>Process Overview</h3>
<ol>
<li><strong>Downloading the <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code> binary</strong></li>
<li><strong>Creating the AWS Lambda layer(s) and configuring our function</strong></li>
<li><strong>Writing the AWS Lambda function</strong>
<ul>
<li>We will use Python&#x27;s <a href="https://docs.python.org/3/library/subprocess.html" target="_blank"><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">subprocess</code> module</a> to call the <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code> command</li>
<li>For more in-depth Python focused usage, also check out <a href="https://pypi.org/project/pdfkit/" target="_blank">pdfkit</a></li>
</ul>
</li>
</ol>
<h3>Prerequisites</h3>
<p>This article assumes access to an AWS account (free-tier is acceptable) and basic knowledge of AWS Lambda/S3 and Python.</p>
<h3>Functional Requirements</h3>
<ol>
<li>Allow passing either an S3 file key or an HTML string</li>
<li>Return a file key for the generated PDF</li>
<li>Accept a small set of options for the <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code> command
<ul>
<li>A full man page can be found <a href="https://wkhtmltopdf.org/usage/wkhtmltopdf.txt" target="_blank">here</a></li>
<li>Most of the ones we&#x27;d want anyways are the default (i.e. <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--images</code>, <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--enable-external-links</code>, etc.)</li>
</ul>
</li>
</ol>
<p>Functionality for the following options</p>
<ul>
<li><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--orientation &lt;orientation&gt;</code></li>
<li><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--title &lt;text&gt;</code></li>
<li><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--margin-bottom &lt;unitreal&gt;</code></li>
<li><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--margin-left &lt;unitreal&gt;</code></li>
<li><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--margin-right &lt;unitreal&gt;</code></li>
<li><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--margin-top &lt;unitreal&gt;</code></li>
</ul>
<h3>Assumptions</h3>
<ol>
<li>The HTML string or file will be valid and will include the necessary tags (<code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">&lt;!DOCTYPE html&gt;</code>, <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">&lt;html&gt;</code>, <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">&lt;head&gt;</code>, <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">&lt;body&gt;</code>). <strong>It is very important that you check validity of this HTML prior to calling this function if you ever use something similar in production. It may be best to only accept S3 file keys instead of HTML strings, but this is simply to show our functions possibilities or be used as an internal tool.</strong></li>
<li>The event payload will contain all valid values (S3 bucket name, file key, <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code> options etc.)</li>
</ol>
<h3>Notes</h3>
<p>This article will use <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">us-east-2</code> for the AWS region, changing this shouldn&#x27;t effect functionality, just the links within the article.</p>
<p>A better way to do this is through <a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html" target="_blank">AWS Serverless Application Model (SAM)</a>, but this is more tailored for those looking for the basic setup through the AWS Management Console.</p>
<hr/>
<p>A common task I&#x27;ve found myself undertaking recently is programmatically converting an HTML file/string to an embedded and stylized PDF file.</p>
<p>An example use case for this might be exporting a self-managed customer invoice or generating a daily report from an existing HTML template. For those who have used template languages before, you can probably imagine the usefulness of a function like this in combination with <a href="https://jinja.palletsprojects.com/en/2.11.x/" target="_blank">Jinja</a> or template rendering engines commonly found in Web Frameworks (like <a href="https://www.djangoproject.com/" target="_blank">Django</a>).</p>
<p>After doing some research on third party libraries that could simplify our goal, I decided to use <a href="https://wkhtmltopdf.org/" target="_blank"><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code></a>.</p>
<p><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code> is an open-source command line tool that enables you to easy convert an HTML file to a PDF file. This is exactly what we&#x27;re looking for. We will call the <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code> command using the <a href="https://docs.python.org/3/library/subprocess.html" target="_blank"><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">subprocess</code></a> Python library. For more in-depth Python usage, you can check out <a href="https://pypi.org/project/pdfkit/" target="_blank">pdfkit</a>.</p>
<p>Let&#x27;s dive into it.</p>
<hr/>
<h2>Why AWS Lambda?</h2>
<p><a href="https://aws.amazon.com/lambda/" target="_blank">AWS Lambda</a> provides serverless computing functions where you don&#x27;t need to manage any servers or containers, you can simply call your function synchronously or asynchronously, and it will be executed and scaled automatically.</p>
<p>Lambda has a ton of use cases and is something I have personally used many times and am a big fan of.</p>
<p><em>For our goal, AWS Lambda is a powerful tool for the following reasons</em></p>
<ul>
<li>It allows us to offload processing away from the server
<ul>
<li>This is more of a general benefit, we won&#x27;t actually be calling this function from a running server</li>
<li>These calls will also be scaled automatically</li>
</ul>
</li>
<li>Our dependencies, specifically the <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code> binary, can be handled well through <a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html" target="_blank">AWS Lambda layers</a>
<ul>
<li>This helps to avoid dealing with different Linux distributions or multiple installation locations</li>
</ul>
</li>
</ul>
<p><strong>Below is an explanation of why handling the dependencies through layers will avoid issues. For continued instruction, you can skip to the next section.</strong></p>
<h3>Issues with downloading the binary</h3>
<p>When I was first using this library, I was also using <a href="https://pypi.org/project/pdfkit/" target="_blank"><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">pdfkit</code></a> to drive this interaction.  At the top of the installation instructions, you can see the following warning:</p>
<p style="background-color:orange;padding:7px 20px;text-align:center;border-radius:6px">
<i>&quot;<b>Warning!</b>¬†Version in debian/ubuntu repos have reduced functionality (because it compiled without the wkhtmltopdf QT patches), such as adding outlines, headers, footers, TOC etc. To use this options you should install static binary from wkhtmltopdf site&quot;</i>
</p>
<p>When I first installed <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code>, I didn&#x27;t heed the warning and just ran the following:</p>
<pre><div class="codeblock_CodeBlock__P_tQD"><div class="sc-gsDKAQ bnYxmP"><span style="font-size:inherit;font-family:inherit;background:#282c34;color:#abb2bf;border-radius:3px;display:flex;line-height:1.4285714285714286;overflow-x:auto;white-space:pre"><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px;float:left;padding-right:10px"><span class="react-syntax-highlighter-line-number">1
</span></code><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px">sudo apt-get install wkhtmltopdf</code></span><button type="button" class="sc-bdvvtL dHMcRP"><svg class="icon" viewBox="0 0 384 512" width="16pt" height="16pt" fill="#abb2bf"><path d="M280 240H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zm0 96H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zM112 232c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zm0 96c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zM336 64h-80c0-35.3-28.7-64-64-64s-64 28.7-64 64H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zM192 48c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16zm144 408c0 4.4-3.6 8-8 8H56c-4.4 0-8-3.6-8-8V120c0-4.4 3.6-8 8-8h40v32c0 8.8 7.2 16 16 16h160c8.8 0 16-7.2 16-16v-32h40c4.4 0 8 3.6 8 8v336z"></path></svg></button></div></div></pre>
<p>On initial inspection, I wasn&#x27;t experiencing the problems they mentioned (<em>at least in my local environment</em>). The issues came when I actually pushed up code using this library to a staging environment and I noticed the PDFs were no longer generating.</p>
<p>I was able to remedy this by installing in an alternative way:</p>
<pre><div class="codeblock_CodeBlock__P_tQD"><div class="sc-gsDKAQ bnYxmP"><span style="font-size:inherit;font-family:inherit;background:#282c34;color:#abb2bf;border-radius:3px;display:flex;line-height:1.4285714285714286;overflow-x:auto;white-space:pre"><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px;float:left;padding-right:10px"><span class="react-syntax-highlighter-line-number">1
</span><span class="react-syntax-highlighter-line-number">2
</span><span class="react-syntax-highlighter-line-number">3
</span><span class="react-syntax-highlighter-line-number">4
</span></code><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px">sudo apt-get remove --purge wkhtmltopdf
wget https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-1/wkhtmltox_0.12.6-1.bionic_amd64.deb
sudo dpkg -i wkhtmltox_0.12.6-1.bionic_amd64.deb
rm wkhtmltox_0.12.6-1.bionic_amd64.deb</code></span><button type="button" class="sc-bdvvtL dHMcRP"><svg class="icon" viewBox="0 0 384 512" width="16pt" height="16pt" fill="#abb2bf"><path d="M280 240H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zm0 96H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zM112 232c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zm0 96c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zM336 64h-80c0-35.3-28.7-64-64-64s-64 28.7-64 64H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zM192 48c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16zm144 408c0 4.4-3.6 8-8 8H56c-4.4 0-8-3.6-8-8V120c0-4.4 3.6-8 8-8h40v32c0 8.8 7.2 16 16 16h160c8.8 0 16-7.2 16-16v-32h40c4.4 0 8 3.6 8 8v336z"></path></svg></button></div></div></pre>
<p>This isn&#x27;t a big deal, but managing this dependency could get tedious if your architecture has multiple servers that need installed with different Linux distributions.</p>
<p>Putting this binary into an AWS Lambda Layer can help solve this by having a single point of installation and management.</p>
<h2>Downloading the <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code> binary</h2>
<p>The <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code> site actually lists using this library with AWS Lambda as a <a href="https://wkhtmltopdf.org/downloads.html#how-do-i-use-it-in-aws-lambda" target="_blank">FAQ</a> and gives the following response to this question:</p>
<p><em>&quot;All files required for lambda layer are packed in one zip archive (Amazon Linux 2 / lambda zip)&quot;</em></p>
<p>You can download the binary on the releases page under the <a href="https://wkhtmltopdf.org/downloads.html#stable" target="_blank">Stable releases</a>. You&#x27;ll see an entry under <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">Amazon Linux</code> with <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">lambda zip</code> as the architecture.</p>
<p>Or, you can click <a href="https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-4/wkhtmltox-0.12.6-4.amazonlinux2_lambda.zip" target="_blank">here</a> (I likely won&#x27;t update this link, so probably best to go directly to the release page).</p>
<p><em>Random note:</em> If you need more fonts for future usage, I&#x27;ve found that <a href="https://github.com/brandonlim-hs/fonts-aws-lambda-layer" target="_blank">this is a good resource</a>. You may need to include one of these fonts as a layer in your lambda function (via ARN) if your function has issues in the beginning.</p>
<h2>Creating the AWS Lambda layers</h2>
<p><a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html" target="_blank">AWS Lambda layers</a> allow us to add in &quot;layers&quot; of dependencies for our functions. An alternative to this is uploading your lambda function as a deployment package or using AWS SAM (Serverless Application Model), but that is out of the scope of this post.</p>
<h3><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code></h3>
<p>Now that we have the zip file downloaded, let&#x27;s add our file as a layer in the <a href="https://us-east-2.console.aws.amazon.com/console/home?region=us-east-2" target="_blank">AWS Management Console</a>.</p>
<p>Go to the <a href="https://us-east-2.console.aws.amazon.com/lambda/home?region=us-east-2#/layers" target="_blank">Layers section</a> on the AWS Lambda page and click <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">Create layer</code>.</p>
<p>Then, add the following Layer configuration.</p>
<div style="display:flex;justify-content:center" class="ZoomImageWrapper"><label><input type="checkbox" class="utils_displayNone__rveqn"/><img src="/images/converting-html-to-pdf/layer-configuration.jpg" width="680" height="488" class="postImg" alt="AWS Lambda layer configuration" loading="eager"/></label></div>
<p>Notice that we don&#x27;t add a runtime here, this is intentional since our layer is a binary.</p>
<p>Click Create and take note of your new layer&#x27;s Version ARN as we are about to use it to add to our function.</p>
<p>Now we&#x27;re set up to create our function!</p>
<h2>Writing the AWS Lambda function</h2>
<p>Navigate to the <a href="https://us-east-2.console.aws.amazon.com/lambda/home?region=us-east-2#/functions" target="_blank">Functions page</a> within the AWS Lambda service and click <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">Create function</code>.</p>
<p>Select <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">Author from scratch</code>, and add the following configuration.</p>
<div style="display:flex;justify-content:center" class="ZoomImageWrapper"><label><input type="checkbox" class="utils_displayNone__rveqn"/><img src="/images/converting-html-to-pdf/function-configuration.jpg" width="1004" height="475" class="postImg" alt="AWS Lambda function configuration" loading="lazy"/></label></div>
<p>You can ignore the <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">Advanced settings</code> for our use case.</p>
<p>Once the function is created, we have just a few configuration additions to make.</p>
<h3>Adding the layer to our Lambda function</h3>
<p>Now that our function is created, the first thing we want to do is add our <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code> layer.</p>
<p>At the top of the Function Overview panel, click the <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">Layers</code> button right below your function name. This will bring you down to the layers section. Now click Add a layer.</p>
<p>Click on <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">Specify an ARN</code> and copy your Layer Version ARN from earlier.</p>
<div style="display:flex;justify-content:center" class="ZoomImageWrapper"><label><input type="checkbox" class="utils_displayNone__rveqn"/><img src="/images/converting-html-to-pdf/add-layer.jpg" width="680" height="316" class="postImg" alt="AWS Lambda add layer" loading="lazy"/></label></div>
<p>The reason why we need to specify our layer by ARN is because we didn&#x27;t define a runtime above.</p>
<p style="background-color:#9bc2cf;padding:7px 20px;text-align:center;border-radius:6px">
<b>Important!</b> If your function generates a PDF with a bunch of black squares, this is likely because there is no font configuration within Lambda. To solve this, you can go to [this link](https://github.com/brandonlim-hs/fonts-aws-lambda-layer&quot;) that I mentioned earlier, and copy one of the AWS Linux Fonts ARNs for your region (or build from scratch), add the environment variable in the README, and repeat these steps to add a font layer.
</p>
<h3>Add permission to access your S3 bucket</h3>
<p>One final function configuration that we need to add is permission for our function to access Amazon S3.  To do this, navigate to the Configuration tab below your Function Overview.</p>
<p>Under Configuration, go to the Permissions section. Here, you will see your generated Execution Role. Click this link to go to the IAM Console.</p>
<p>From here, click Attach policies, and add the <strong>AmazonS3FullAccess</strong> policy like so</p>
<div style="display:flex;justify-content:center" class="ZoomImageWrapper"><label><input type="checkbox" class="utils_displayNone__rveqn"/><img src="/images/converting-html-to-pdf/iam-policy.jpg" width="1004" height="461" class="postImg" alt="AWS Lambda IAM policy" loading="lazy"/></label></div>
<p>Now that our function is configured, we can dive into the actual requirements and code!</p>
<h3>Requirements</h3>
<ol>
<li>Allow passing either an S3 file key or an HTML string</li>
<li>Return a file key for the generated PDF</li>
<li>Accept a small set of options for the <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code> command
<ul>
<li>A full man page can be found <a href="https://wkhtmltopdf.org/usage/wkhtmltopdf.txt" target="_blank">here</a></li>
<li>Most of the ones we&#x27;d want anyways are the default (i.e. <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--images</code>, <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--enable-external-links</code>, etc.)</li>
</ul>
</li>
</ol>
<p>Let&#x27;s allow the user to pass the following options</p>
<ul>
<li><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--orientation &lt;orientation&gt;</code> - the common page orientation for the PDF file.
<ul>
<li>Valid values are <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">Landscape</code> or <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">Portrait</code></li>
</ul>
</li>
<li><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--title &lt;text&gt;</code> - the title of the generated file.</li>
<li>The margins of the file
<ul>
<li><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--margin-bottom &lt;unitreal&gt;</code></li>
<li><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--margin-left &lt;unitreal&gt;</code> (default is 10mm)</li>
<li><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--margin-right &lt;unitreal&gt;</code>  (default is 10mm)</li>
<li><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">--margin-top &lt;unitreal&gt;</code></li>
</ul>
</li>
</ul>
<h3>Assumptions</h3>
<ol>
<li>The HTML string or file will be valid and will include the necessary tags (<code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">&lt;!DOCTYPE html&gt;</code>, <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">&lt;html&gt;</code>, <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">&lt;head&gt;</code>, <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">&lt;body&gt;</code>)</li>
<li>The event payload will contain all valid values (S3 bucket name, file key, <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code> options etc.)</li>
</ol>
<h3>The function code</h3>
<p>By default, you will see the following handler.</p>
<pre><div class="codeblock_CodeBlock__P_tQD"><div class="sc-gsDKAQ bnYxmP"><span style="font-size:inherit;font-family:inherit;background:#282c34;color:#abb2bf;border-radius:3px;display:flex;line-height:1.4285714285714286;overflow-x:auto;white-space:pre"><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px;float:left;padding-right:10px"><span class="react-syntax-highlighter-line-number">1
</span><span class="react-syntax-highlighter-line-number">2
</span><span class="react-syntax-highlighter-line-number">3
</span><span class="react-syntax-highlighter-line-number">4
</span><span class="react-syntax-highlighter-line-number">5
</span><span class="react-syntax-highlighter-line-number">6
</span></code><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px">def lambda_handler(event, context):
    # TODO implement
    return {
        &#x27;statusCode&#x27;: 200,
        &#x27;body&#x27;: json.dumps(&#x27;Hello from Lambda!&#x27;)
    }</code></span><button type="button" class="sc-bdvvtL dHMcRP"><svg class="icon" viewBox="0 0 384 512" width="16pt" height="16pt" fill="#abb2bf"><path d="M280 240H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zm0 96H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zM112 232c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zm0 96c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zM336 64h-80c0-35.3-28.7-64-64-64s-64 28.7-64 64H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zM192 48c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16zm144 408c0 4.4-3.6 8-8 8H56c-4.4 0-8-3.6-8-8V120c0-4.4 3.6-8 8-8h40v32c0 8.8 7.2 16 16 16h160c8.8 0 16-7.2 16-16v-32h40c4.4 0 8 3.6 8 8v336z"></path></svg></button></div></div></pre>
<p>This is the code that will be executed when your function is called. We&#x27;ll come back to this in a bit.</p>
<h4>The imports</h4>
<p>First, let&#x27;s go ahead and import all of the Python libraries that we&#x27;ll need and set up some basic tools like the <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">S3 client</code> and our <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">logger</code>.</p>
<pre><div class="codeblock_CodeBlock__P_tQD"><div class="sc-gsDKAQ bnYxmP"><span style="font-size:inherit;font-family:inherit;background:#282c34;color:#abb2bf;border-radius:3px;display:flex;line-height:1.4285714285714286;overflow-x:auto;white-space:pre"><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px;float:left;padding-right:10px"><span class="react-syntax-highlighter-line-number">1
</span><span class="react-syntax-highlighter-line-number">2
</span><span class="react-syntax-highlighter-line-number">3
</span><span class="react-syntax-highlighter-line-number">4
</span><span class="react-syntax-highlighter-line-number">5
</span><span class="react-syntax-highlighter-line-number">6
</span><span class="react-syntax-highlighter-line-number">7
</span><span class="react-syntax-highlighter-line-number">8
</span><span class="react-syntax-highlighter-line-number">9
</span><span class="react-syntax-highlighter-line-number">10
</span><span class="react-syntax-highlighter-line-number">11
</span><span class="react-syntax-highlighter-line-number">12
</span><span class="react-syntax-highlighter-line-number">13
</span><span class="react-syntax-highlighter-line-number">14
</span><span class="react-syntax-highlighter-line-number">15
</span><span class="react-syntax-highlighter-line-number">16
</span><span class="react-syntax-highlighter-line-number">17
</span></code><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px">from datetime import datetime
import json
import logging
import os
import subprocess
from typing import Optional

import boto3
from botocore.exceptions import ClientError


# Set up logging
logger = logging.getLogger()
logger.setLevel(logging.INFO)

# Get the s3 client
s3 = boto3.client(&#x27;s3&#x27;)</code></span><button type="button" class="sc-bdvvtL dHMcRP"><svg class="icon" viewBox="0 0 384 512" width="16pt" height="16pt" fill="#abb2bf"><path d="M280 240H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zm0 96H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zM112 232c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zm0 96c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zM336 64h-80c0-35.3-28.7-64-64-64s-64 28.7-64 64H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zM192 48c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16zm144 408c0 4.4-3.6 8-8 8H56c-4.4 0-8-3.6-8-8V120c0-4.4 3.6-8 8-8h40v32c0 8.8 7.2 16 16 16h160c8.8 0 16-7.2 16-16v-32h40c4.4 0 8 3.6 8 8v336z"></path></svg></button></div></div></pre>
<p>Now based upon our requirements, we&#x27;ll need helper functions to</p>
<ol>
<li>Download an HTML file from S3</li>
<li>Upload a file to S3</li>
</ol>
<p>Let&#x27;s start with those, and then we&#x27;ll return to our lambda handler.</p>
<h4>Downloading/uploading the file</h4>
<p><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html" target="_blank"><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">boto3</code></a> makes it really easy to interact with S3.  Using <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">boto3</code>, we can add the following helper functions.</p>
<pre><div class="codeblock_CodeBlock__P_tQD"><div class="sc-gsDKAQ bnYxmP"><span style="font-size:inherit;font-family:inherit;background:#282c34;color:#abb2bf;border-radius:3px;display:flex;line-height:1.4285714285714286;overflow-x:auto;white-space:pre"><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px;float:left;padding-right:10px"><span class="react-syntax-highlighter-line-number">1
</span><span class="react-syntax-highlighter-line-number">2
</span><span class="react-syntax-highlighter-line-number">3
</span><span class="react-syntax-highlighter-line-number">4
</span><span class="react-syntax-highlighter-line-number">5
</span><span class="react-syntax-highlighter-line-number">6
</span><span class="react-syntax-highlighter-line-number">7
</span><span class="react-syntax-highlighter-line-number">8
</span><span class="react-syntax-highlighter-line-number">9
</span><span class="react-syntax-highlighter-line-number">10
</span><span class="react-syntax-highlighter-line-number">11
</span><span class="react-syntax-highlighter-line-number">12
</span><span class="react-syntax-highlighter-line-number">13
</span><span class="react-syntax-highlighter-line-number">14
</span><span class="react-syntax-highlighter-line-number">15
</span><span class="react-syntax-highlighter-line-number">16
</span><span class="react-syntax-highlighter-line-number">17
</span><span class="react-syntax-highlighter-line-number">18
</span><span class="react-syntax-highlighter-line-number">19
</span><span class="react-syntax-highlighter-line-number">20
</span><span class="react-syntax-highlighter-line-number">21
</span><span class="react-syntax-highlighter-line-number">22
</span><span class="react-syntax-highlighter-line-number">23
</span><span class="react-syntax-highlighter-line-number">24
</span><span class="react-syntax-highlighter-line-number">25
</span><span class="react-syntax-highlighter-line-number">26
</span><span class="react-syntax-highlighter-line-number">27
</span><span class="react-syntax-highlighter-line-number">28
</span><span class="react-syntax-highlighter-line-number">29
</span><span class="react-syntax-highlighter-line-number">30
</span><span class="react-syntax-highlighter-line-number">31
</span><span class="react-syntax-highlighter-line-number">32
</span><span class="react-syntax-highlighter-line-number">33
</span><span class="react-syntax-highlighter-line-number">34
</span><span class="react-syntax-highlighter-line-number">35
</span><span class="react-syntax-highlighter-line-number">36
</span><span class="react-syntax-highlighter-line-number">37
</span><span class="react-syntax-highlighter-line-number">38
</span><span class="react-syntax-highlighter-line-number">39
</span><span class="react-syntax-highlighter-line-number">40
</span></code><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px">def download_s3_file(bucket: str, file_key: str) -&gt; str:
    &quot;&quot;&quot;Downloads a file from s3 to `/tmp/[File Key]`.
    
    Args:
        bucket (str): Name of the bucket where the file lives.
        file_key (str): The file key of the file in the bucket.

    Returns:
        The local file name as a string.
    &quot;&quot;&quot;
    local_filename = f&#x27;/tmp/{file_key}&#x27;
    s3.download_file(Bucket=bucket, Key=file_key, Filename=local_filename)
    logger.info(&#x27;Downloaded HTML file to %s&#x27; % local_filename)

    return local_filename
    
    
def upload_file_to_s3(bucket: str, filename: str) -&gt; Optional[str]:
    &quot;&quot;&quot;Uploads the generated PDF to s3.
    
    Args:
        bucket (str): Name of the s3 bucket to upload the PDF to.
        filename (str): Location of the file to upload to s3.
        
    Returns:
        The file key of the file in s3 if the upload was successful.
        If the upload failed, then `None` will be returned.
    &quot;&quot;&quot;
    file_key = None
    try:
        file_key = filename.replace(&#x27;/tmp/&#x27;, &#x27;&#x27;)
        s3.upload_file(Filename=filename, Bucket=bucket, Key=file_key)
        logger.info(&#x27;Successfully uploaded the PDF to %s as %s&#x27;
                    % (bucket, file_key))
    except ClientError as e:
        logger.error(&#x27;Failed to upload file to s3.&#x27;)
        logger.error(e)
        file_key = None
        
    return file_key</code></span><button type="button" class="sc-bdvvtL dHMcRP"><svg class="icon" viewBox="0 0 384 512" width="16pt" height="16pt" fill="#abb2bf"><path d="M280 240H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zm0 96H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zM112 232c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zm0 96c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zM336 64h-80c0-35.3-28.7-64-64-64s-64 28.7-64 64H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zM192 48c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16zm144 408c0 4.4-3.6 8-8 8H56c-4.4 0-8-3.6-8-8V120c0-4.4 3.6-8 8-8h40v32c0 8.8 7.2 16 16 16h160c8.8 0 16-7.2 16-16v-32h40c4.4 0 8 3.6 8 8v336z"></path></svg></button></div></div></pre>
<h4>Parsing the event</h4>
<p>One thing we haven&#x27;t talked about yet is the data that we&#x27;ll need to pass our function.</p>
<p>Let&#x27;s define our JSON event schema as the following.</p>
<pre><div class="codeblock_CodeBlock__P_tQD"><div class="sc-gsDKAQ bnYxmP"><span style="font-size:inherit;font-family:inherit;background:#282c34;color:#abb2bf;border-radius:3px;display:flex;line-height:1.4285714285714286;overflow-x:auto;white-space:pre"><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px;float:left;padding-right:10px"><span class="react-syntax-highlighter-line-number">1
</span><span class="react-syntax-highlighter-line-number">2
</span><span class="react-syntax-highlighter-line-number">3
</span><span class="react-syntax-highlighter-line-number">4
</span><span class="react-syntax-highlighter-line-number">5
</span><span class="react-syntax-highlighter-line-number">6
</span><span class="react-syntax-highlighter-line-number">7
</span><span class="react-syntax-highlighter-line-number">8
</span><span class="react-syntax-highlighter-line-number">9
</span><span class="react-syntax-highlighter-line-number">10
</span></code><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px">{
    &quot;bucket&quot;: &quot;&lt;Name of the bucket where the file is stored currently and will be stored after processing&gt; [Required]&quot;,
    &quot;file_key&quot;: &quot;&lt;File key where the file is store in S3&gt; [Required if `html_string` is not defined]&quot;,
    &quot;html_string&quot;: &quot;&lt;HTML string to convert to a PDF&gt; [Required if `file_key` is not defined]&quot;,
    &quot;wkhtmltopdf_options&quot;: {
        &quot;orientation&quot;: &quot;&lt;`landscape` or `portrait`&gt; [Optional: Default is `portrait`]&quot;,
        &quot;title&quot;: &quot;&lt;Title of the PDF&gt; [Optional]&quot;,
        &quot;margin&quot;: &quot;&lt;Margin of the PDF (same format as css [&lt;top&gt; &lt;right&gt; &lt;bottom&gt; &lt;left&gt;] (all must be included)).&gt; [Optional]&quot;
    }
}</code></span><button type="button" class="sc-bdvvtL dHMcRP"><svg class="icon" viewBox="0 0 384 512" width="16pt" height="16pt" fill="#abb2bf"><path d="M280 240H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zm0 96H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zM112 232c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zm0 96c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zM336 64h-80c0-35.3-28.7-64-64-64s-64 28.7-64 64H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zM192 48c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16zm144 408c0 4.4-3.6 8-8 8H56c-4.4 0-8-3.6-8-8V120c0-4.4 3.6-8 8-8h40v32c0 8.8 7.2 16 16 16h160c8.8 0 16-7.2 16-16v-32h40c4.4 0 8 3.6 8 8v336z"></path></svg></button></div></div></pre>
<p><code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf_options</code> is an optional object. If the included options are not valid, they will not be included.</p>
<p>We can access all of the data passed to our function from the <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">event</code> parameter in the <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">lambda_handler</code> function.</p>
<p>Now, let&#x27;s jump back to the <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">lambda_handler</code> function and add some code to pull out the data from our event and put together the remaining pieces of actually calling the <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">wkhtmltopdf</code> executable to finish our lambda function.</p>
<pre><div class="codeblock_CodeBlock__P_tQD"><div class="sc-gsDKAQ bnYxmP"><span style="font-size:inherit;font-family:inherit;background:#282c34;color:#abb2bf;border-radius:3px;display:flex;line-height:1.4285714285714286;overflow-x:auto;white-space:pre"><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px;float:left;padding-right:10px"><span class="react-syntax-highlighter-line-number">1
</span><span class="react-syntax-highlighter-line-number">2
</span><span class="react-syntax-highlighter-line-number">3
</span><span class="react-syntax-highlighter-line-number">4
</span><span class="react-syntax-highlighter-line-number">5
</span><span class="react-syntax-highlighter-line-number">6
</span><span class="react-syntax-highlighter-line-number">7
</span><span class="react-syntax-highlighter-line-number">8
</span><span class="react-syntax-highlighter-line-number">9
</span><span class="react-syntax-highlighter-line-number">10
</span><span class="react-syntax-highlighter-line-number">11
</span><span class="react-syntax-highlighter-line-number">12
</span><span class="react-syntax-highlighter-line-number">13
</span><span class="react-syntax-highlighter-line-number">14
</span><span class="react-syntax-highlighter-line-number">15
</span><span class="react-syntax-highlighter-line-number">16
</span><span class="react-syntax-highlighter-line-number">17
</span><span class="react-syntax-highlighter-line-number">18
</span><span class="react-syntax-highlighter-line-number">19
</span><span class="react-syntax-highlighter-line-number">20
</span><span class="react-syntax-highlighter-line-number">21
</span><span class="react-syntax-highlighter-line-number">22
</span><span class="react-syntax-highlighter-line-number">23
</span><span class="react-syntax-highlighter-line-number">24
</span><span class="react-syntax-highlighter-line-number">25
</span><span class="react-syntax-highlighter-line-number">26
</span><span class="react-syntax-highlighter-line-number">27
</span><span class="react-syntax-highlighter-line-number">28
</span><span class="react-syntax-highlighter-line-number">29
</span><span class="react-syntax-highlighter-line-number">30
</span><span class="react-syntax-highlighter-line-number">31
</span><span class="react-syntax-highlighter-line-number">32
</span><span class="react-syntax-highlighter-line-number">33
</span><span class="react-syntax-highlighter-line-number">34
</span><span class="react-syntax-highlighter-line-number">35
</span><span class="react-syntax-highlighter-line-number">36
</span><span class="react-syntax-highlighter-line-number">37
</span><span class="react-syntax-highlighter-line-number">38
</span><span class="react-syntax-highlighter-line-number">39
</span><span class="react-syntax-highlighter-line-number">40
</span><span class="react-syntax-highlighter-line-number">41
</span><span class="react-syntax-highlighter-line-number">42
</span><span class="react-syntax-highlighter-line-number">43
</span><span class="react-syntax-highlighter-line-number">44
</span><span class="react-syntax-highlighter-line-number">45
</span><span class="react-syntax-highlighter-line-number">46
</span><span class="react-syntax-highlighter-line-number">47
</span><span class="react-syntax-highlighter-line-number">48
</span><span class="react-syntax-highlighter-line-number">49
</span><span class="react-syntax-highlighter-line-number">50
</span><span class="react-syntax-highlighter-line-number">51
</span><span class="react-syntax-highlighter-line-number">52
</span><span class="react-syntax-highlighter-line-number">53
</span><span class="react-syntax-highlighter-line-number">54
</span><span class="react-syntax-highlighter-line-number">55
</span><span class="react-syntax-highlighter-line-number">56
</span><span class="react-syntax-highlighter-line-number">57
</span><span class="react-syntax-highlighter-line-number">58
</span><span class="react-syntax-highlighter-line-number">59
</span><span class="react-syntax-highlighter-line-number">60
</span><span class="react-syntax-highlighter-line-number">61
</span><span class="react-syntax-highlighter-line-number">62
</span><span class="react-syntax-highlighter-line-number">63
</span><span class="react-syntax-highlighter-line-number">64
</span><span class="react-syntax-highlighter-line-number">65
</span><span class="react-syntax-highlighter-line-number">66
</span><span class="react-syntax-highlighter-line-number">67
</span><span class="react-syntax-highlighter-line-number">68
</span><span class="react-syntax-highlighter-line-number">69
</span><span class="react-syntax-highlighter-line-number">70
</span><span class="react-syntax-highlighter-line-number">71
</span><span class="react-syntax-highlighter-line-number">72
</span><span class="react-syntax-highlighter-line-number">73
</span><span class="react-syntax-highlighter-line-number">74
</span><span class="react-syntax-highlighter-line-number">75
</span><span class="react-syntax-highlighter-line-number">76
</span><span class="react-syntax-highlighter-line-number">77
</span><span class="react-syntax-highlighter-line-number">78
</span><span class="react-syntax-highlighter-line-number">79
</span><span class="react-syntax-highlighter-line-number">80
</span><span class="react-syntax-highlighter-line-number">81
</span><span class="react-syntax-highlighter-line-number">82
</span><span class="react-syntax-highlighter-line-number">83
</span><span class="react-syntax-highlighter-line-number">84
</span><span class="react-syntax-highlighter-line-number">85
</span><span class="react-syntax-highlighter-line-number">86
</span><span class="react-syntax-highlighter-line-number">87
</span><span class="react-syntax-highlighter-line-number">88
</span><span class="react-syntax-highlighter-line-number">89
</span><span class="react-syntax-highlighter-line-number">90
</span><span class="react-syntax-highlighter-line-number">91
</span><span class="react-syntax-highlighter-line-number">92
</span><span class="react-syntax-highlighter-line-number">93
</span><span class="react-syntax-highlighter-line-number">94
</span><span class="react-syntax-highlighter-line-number">95
</span><span class="react-syntax-highlighter-line-number">96
</span><span class="react-syntax-highlighter-line-number">97
</span><span class="react-syntax-highlighter-line-number">98
</span><span class="react-syntax-highlighter-line-number">99
</span><span class="react-syntax-highlighter-line-number">100
</span><span class="react-syntax-highlighter-line-number">101
</span><span class="react-syntax-highlighter-line-number">102
</span><span class="react-syntax-highlighter-line-number">103
</span><span class="react-syntax-highlighter-line-number">104
</span><span class="react-syntax-highlighter-line-number">105
</span><span class="react-syntax-highlighter-line-number">106
</span></code><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px">def lambda_handler(event, context):
    logger.info(event)

    # bucket is always required
    try:
        bucket = event[&#x27;bucket&#x27;]
    except KeyError:
        error_message = &#x27;Missing required &quot;bucket&quot; parameter from request payload.&#x27;
        logger.error(error_message)
        return {
            &#x27;status&#x27;: 400,
            &#x27;body&#x27;: json.dumps(error_message),
        }

    # html_string and file_key are conditionally required, so let&#x27;s try to get both
    try:
        file_key = event[&#x27;file_key&#x27;]
    except KeyError:
        file_key = None

    try:
        html_string = event[&#x27;html_string&#x27;]
    except KeyError:
        html_string = None

    if file_key is None and html_string is None:
        error_message = (
            &#x27;Missing both a &quot;file_key&quot; and &quot;html_string&quot; &#x27;
            &#x27;from request payload. One of these must be &#x27;
            &#x27;included.&#x27;
        )
        logger.error(error_message)
        return {
            &#x27;status&#x27;: 400,
            &#x27;body&#x27;: json.dumps(error_message),
        }

    # Now we can check for the option wkhtmltopdf_options and map them to values
    # Again, part of our assumptions are that these are valid
    wkhtmltopdf_options = {}
    if &#x27;wkhtmltopdf_options&#x27; in event:
        # Margin is &lt;top&gt; &lt;right&gt; &lt;bottom&gt; &lt;left&gt;
        if &#x27;margin&#x27; in event[&#x27;wkhtmltopdf_options&#x27;]:
            margins = event[&#x27;wkhtmltopdf_options&#x27;][&#x27;margin&#x27;].split(&#x27; &#x27;)
            if len(margins) == 4:
                wkhtmltopdf_options[&#x27;margin-top&#x27;] = margins[0]
                wkhtmltopdf_options[&#x27;margin-right&#x27;] = margins[1]
                wkhtmltopdf_options[&#x27;margin-bottom&#x27;] = margins[2]
                wkhtmltopdf_options[&#x27;margin-left&#x27;] = margins[3]

        if &#x27;orientation&#x27; in event[&#x27;wkhtmltopdf_options&#x27;]:
            wkhtmltopdf_options[&#x27;orientation&#x27;] = &#x27;portrait&#x27; \
                if event[&#x27;wkhtmltopdf_options&#x27;][&#x27;orientation&#x27;].lower() not in [&#x27;portrait&#x27;, &#x27;landscape&#x27;] \
                else event[&#x27;wkhtmltopdf_options&#x27;][&#x27;orientation&#x27;].lower()

        if &#x27;title&#x27; in event[&#x27;wkhtmltopdf_options&#x27;]:
            wkhtmltopdf_options[&#x27;title&#x27;] = event[&#x27;wkhtmltopdf_options&#x27;][&#x27;title&#x27;]

    # If we got a file_key in the request, let&#x27;s download our file
    # If not, we&#x27;ll write the HTML string to a file
    if file_key is not None:
        local_filename = download_s3_file(bucket, file_key)
    else:
        timestamp = str(datetime.now()).replace(&#x27;.&#x27;, &#x27;&#x27;).replace(&#x27; &#x27;, &#x27;_&#x27;)
        local_filename = f&#x27;/tmp/{timestamp}-html-string.html&#x27;

        # Delete any existing files with that name
        try:
            os.unlink(local_filename)
        except FileNotFoundError:
            pass

        with open(local_filename, &#x27;w&#x27;) as f:
            f.write(html_string)

    # Now we can create our command string to execute and upload the result to s3
    command = &#x27;wkhtmltopdf  --load-error-handling ignore&#x27;  # ignore unecessary errors
    for key, value in wkhtmltopdf_options.items():
        if key == &#x27;title&#x27;:
            value = f&#x27;&quot;{value}&quot;&#x27;
        command += &#x27; --{0} {1}&#x27;.format(key, value)
    command += &#x27; {0} {1}&#x27;.format(local_filename, local_filename.replace(&#x27;.html&#x27;, &#x27;.pdf&#x27;))

    # Important! Remember, we said that we are assuming we&#x27;re accepting valid HTML
    # this should always be checked to avoid allowing any string to be executed
    # from this command. The reason we use shell=True here is because our title
    # can be multiple words.
    subprocess.run(command, shell=True)
    logger.info(&#x27;Successfully generated the PDF.&#x27;)
    file_key = upload_file_to_s3(bucket, local_filename.replace(&#x27;.html&#x27;, &#x27;.pdf&#x27;))

    if file_key is None:
        error_message = (
            &#x27;Failed to generate PDF from the given HTML file.&#x27;
            &#x27; Please check to make sure the file is valid HTML.&#x27;
        )
        logger.error(error_message)
        return {
            &#x27;status&#x27;: 400,
            &#x27;body&#x27;: json.dumps(error_message),
        }

    return {
        &#x27;status&#x27;: 200,
        &#x27;file_key&#x27;: file_key,
    }</code></span><button type="button" class="sc-bdvvtL dHMcRP"><svg class="icon" viewBox="0 0 384 512" width="16pt" height="16pt" fill="#abb2bf"><path d="M280 240H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zm0 96H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zM112 232c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zm0 96c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zM336 64h-80c0-35.3-28.7-64-64-64s-64 28.7-64 64H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zM192 48c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16zm144 408c0 4.4-3.6 8-8 8H56c-4.4 0-8-3.6-8-8V120c0-4.4 3.6-8 8-8h40v32c0 8.8 7.2 16 16 16h160c8.8 0 16-7.2 16-16v-32h40c4.4 0 8 3.6 8 8v336z"></path></svg></button></div></div></pre>
<p>Now you can go to the <strong>Test</strong> tab and create the following test event (change your bucket name as necessary)</p>
<pre><div class="codeblock_CodeBlock__P_tQD"><div class="sc-gsDKAQ bnYxmP"><span style="font-size:inherit;font-family:inherit;background:#282c34;color:#abb2bf;border-radius:3px;display:flex;line-height:1.4285714285714286;overflow-x:auto;white-space:pre"><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px;float:left;padding-right:10px"><span class="react-syntax-highlighter-line-number">1
</span><span class="react-syntax-highlighter-line-number">2
</span><span class="react-syntax-highlighter-line-number">3
</span><span class="react-syntax-highlighter-line-number">4
</span><span class="react-syntax-highlighter-line-number">5
</span><span class="react-syntax-highlighter-line-number">6
</span><span class="react-syntax-highlighter-line-number">7
</span><span class="react-syntax-highlighter-line-number">8
</span><span class="react-syntax-highlighter-line-number">9
</span></code><code style="font-size:inherit;font-family:inherit;line-height:1.6666666666666667;padding:8px">{
    &quot;bucket&quot;: &quot;bucket-for-articles&quot;,
    &quot;html_string&quot;: &quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;This is an example of a simple HTML page.&lt;/body&gt;&lt;/html&gt;&quot;,
    &quot;wkhtmltopdf_options&quot;: {
        &quot;orientation&quot;: &quot;portrait&quot;,
        &quot;title&quot;: &quot;Test PDF Generation&quot;,
        &quot;margin&quot;: &quot;10mm 10mm 10mm 10mm&quot;
    }
}</code></span><button type="button" class="sc-bdvvtL dHMcRP"><svg class="icon" viewBox="0 0 384 512" width="16pt" height="16pt" fill="#abb2bf"><path d="M280 240H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zm0 96H168c-4.4 0-8 3.6-8 8v16c0 4.4 3.6 8 8 8h112c4.4 0 8-3.6 8-8v-16c0-4.4-3.6-8-8-8zM112 232c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zm0 96c-13.3 0-24 10.7-24 24s10.7 24 24 24 24-10.7 24-24-10.7-24-24-24zM336 64h-80c0-35.3-28.7-64-64-64s-64 28.7-64 64H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zM192 48c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16zm144 408c0 4.4-3.6 8-8 8H56c-4.4 0-8-3.6-8-8V120c0-4.4 3.6-8 8-8h40v32c0 8.8 7.2 16 16 16h160c8.8 0 16-7.2 16-16v-32h40c4.4 0 8 3.6 8 8v336z"></path></svg></button></div></div></pre>
<p>You should get a return event with a <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">status</code> of <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">200</code>, and a <code style="font-family:Fira Code;border:none;font-variant-ligatures:none;background-color:rgb(246, 249, 252);padding:3px;border-radius:3px">file_key</code> of your converted file, thus achieving our goal! üéâ</p>
<hr/></article></main></div><footer class="footer_FooterContainer__oKXDJ"><div class="footer_Footer__wsKMY"><div class="footer_SocialLinkWrapper__0F2i_"><a href="https://www.linkedin.com/in/bradley-schoeneweis/" target="_blank" rel="noreferrer"><img width="16" src="/icons/linkedin.svg" alt="linkedin logo" class="footer_SocialLinkLogo__OWB_i"/></a><a href="https://github.com/bschoeneweis" target="_blank" rel="noreferrer"><img width="16" src="/icons/github.svg" alt="github logo" class="footer_SocialLinkLogo__OWB_i"/></a><a href="https://medium.com/@bradley-schoeneweis" target="_blank" rel="noreferrer"><img width="16" src="/icons/medium.svg" alt="medium logo" class="footer_SocialLinkLogo__OWB_i"/></a><a href="https://dev.to/bschoeneweis" target="_blank" rel="noreferrer"><img width="16" src="/icons/dev.svg" alt="dev logo" class="footer_SocialLinkLogo__OWB_i"/></a><a href="/feed.xml"><img width="16" src="/icons/rss.svg" alt="rss logo" class="footer_SocialLinkLogo__OWB_i"/></a></div><div class="footer_CopyrightWrapper__NZEPb"><small>¬© <time>2023</time> Bradley Schoeneweis</small></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"converting-html-to-pdf","contentHtml":"\u003ch2\u003etl;dr\u003c/h2\u003e\n\u003ch3\u003eGoal\u003c/h3\u003e\n\u003cp\u003e\u003cem\u003eTo set up an easy to call HTML to PDF converter as an AWS Lambda function.\u003c/em\u003e\u003c/p\u003e\n\u003ch3\u003eProcess Overview\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eDownloading the \u003ccode\u003ewkhtmltopdf\u003c/code\u003e binary\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCreating the AWS Lambda layer(s) and configuring our function\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eWriting the AWS Lambda function\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003eWe will use Python's \u003ca href=\"https://docs.python.org/3/library/subprocess.html\"\u003e\u003ccode\u003esubprocess\u003c/code\u003e module\u003c/a\u003e to call the \u003ccode\u003ewkhtmltopdf\u003c/code\u003e command\u003c/li\u003e\n\u003cli\u003eFor more in-depth Python focused usage, also check out \u003ca href=\"https://pypi.org/project/pdfkit/\"\u003epdfkit\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003ePrerequisites\u003c/h3\u003e\n\u003cp\u003eThis article assumes access to an AWS account (free-tier is acceptable) and basic knowledge of AWS Lambda/S3 and Python.\u003c/p\u003e\n\u003ch3\u003eFunctional Requirements\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eAllow passing either an S3 file key or an HTML string\u003c/li\u003e\n\u003cli\u003eReturn a file key for the generated PDF\u003c/li\u003e\n\u003cli\u003eAccept a small set of options for the \u003ccode\u003ewkhtmltopdf\u003c/code\u003e command\n\u003cul\u003e\n\u003cli\u003eA full man page can be found \u003ca href=\"https://wkhtmltopdf.org/usage/wkhtmltopdf.txt\"\u003ehere\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eMost of the ones we'd want anyways are the default (i.e. \u003ccode\u003e--images\u003c/code\u003e, \u003ccode\u003e--enable-external-links\u003c/code\u003e, etc.)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eFunctionality for the following options\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e--orientation \u0026#x3C;orientation\u003e\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e--title \u0026#x3C;text\u003e\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e--margin-bottom \u0026#x3C;unitreal\u003e\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e--margin-left \u0026#x3C;unitreal\u003e\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e--margin-right \u0026#x3C;unitreal\u003e\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e--margin-top \u0026#x3C;unitreal\u003e\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eAssumptions\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eThe HTML string or file will be valid and will include the necessary tags (\u003ccode\u003e\u0026#x3C;!DOCTYPE html\u003e\u003c/code\u003e, \u003ccode\u003e\u0026#x3C;html\u003e\u003c/code\u003e, \u003ccode\u003e\u0026#x3C;head\u003e\u003c/code\u003e, \u003ccode\u003e\u0026#x3C;body\u003e\u003c/code\u003e). \u003cstrong\u003eIt is very important that you check validity of this HTML prior to calling this function if you ever use something similar in production. It may be best to only accept S3 file keys instead of HTML strings, but this is simply to show our functions possibilities or be used as an internal tool.\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003eThe event payload will contain all valid values (S3 bucket name, file key, \u003ccode\u003ewkhtmltopdf\u003c/code\u003e options etc.)\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003eNotes\u003c/h3\u003e\n\u003cp\u003eThis article will use \u003ccode\u003eus-east-2\u003c/code\u003e for the AWS region, changing this shouldn't effect functionality, just the links within the article.\u003c/p\u003e\n\u003cp\u003eA better way to do this is through \u003ca href=\"https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html\"\u003eAWS Serverless Application Model (SAM)\u003c/a\u003e, but this is more tailored for those looking for the basic setup through the AWS Management Console.\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eA common task I've found myself undertaking recently is programmatically converting an HTML file/string to an embedded and stylized PDF file.\u003c/p\u003e\n\u003cp\u003eAn example use case for this might be exporting a self-managed customer invoice or generating a daily report from an existing HTML template. For those who have used template languages before, you can probably imagine the usefulness of a function like this in combination with \u003ca href=\"https://jinja.palletsprojects.com/en/2.11.x/\"\u003eJinja\u003c/a\u003e or template rendering engines commonly found in Web Frameworks (like \u003ca href=\"https://www.djangoproject.com/\"\u003eDjango\u003c/a\u003e).\u003c/p\u003e\n\u003cp\u003eAfter doing some research on third party libraries that could simplify our goal, I decided to use \u003ca href=\"https://wkhtmltopdf.org/\"\u003e\u003ccode\u003ewkhtmltopdf\u003c/code\u003e\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ewkhtmltopdf\u003c/code\u003e is an open-source command line tool that enables you to easy convert an HTML file to a PDF file. This is exactly what we're looking for. We will call the \u003ccode\u003ewkhtmltopdf\u003c/code\u003e command using the \u003ca href=\"https://docs.python.org/3/library/subprocess.html\"\u003e\u003ccode\u003esubprocess\u003c/code\u003e\u003c/a\u003e Python library. For more in-depth Python usage, you can check out \u003ca href=\"https://pypi.org/project/pdfkit/\"\u003epdfkit\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eLet's dive into it.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2\u003eWhy AWS Lambda?\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://aws.amazon.com/lambda/\"\u003eAWS Lambda\u003c/a\u003e provides serverless computing functions where you don't need to manage any servers or containers, you can simply call your function synchronously or asynchronously, and it will be executed and scaled automatically.\u003c/p\u003e\n\u003cp\u003eLambda has a ton of use cases and is something I have personally used many times and am a big fan of.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eFor our goal, AWS Lambda is a powerful tool for the following reasons\u003c/em\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIt allows us to offload processing away from the server\n\u003cul\u003e\n\u003cli\u003eThis is more of a general benefit, we won't actually be calling this function from a running server\u003c/li\u003e\n\u003cli\u003eThese calls will also be scaled automatically\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eOur dependencies, specifically the \u003ccode\u003ewkhtmltopdf\u003c/code\u003e binary, can be handled well through \u003ca href=\"https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html\"\u003eAWS Lambda layers\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003eThis helps to avoid dealing with different Linux distributions or multiple installation locations\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eBelow is an explanation of why handling the dependencies through layers will avoid issues. For continued instruction, you can skip to the next section.\u003c/strong\u003e\u003c/p\u003e\n\u003ch3\u003eIssues with downloading the binary\u003c/h3\u003e\n\u003cp\u003eWhen I was first using this library, I was also using \u003ca href=\"https://pypi.org/project/pdfkit/\"\u003e\u003ccode\u003epdfkit\u003c/code\u003e\u003c/a\u003e to drive this interaction.  At the top of the installation instructions, you can see the following warning:\u003c/p\u003e\n\u003cp\u003eWhen I first installed \u003ccode\u003ewkhtmltopdf\u003c/code\u003e, I didn't heed the warning and just ran the following:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003esudo apt-get install wkhtmltopdf\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOn initial inspection, I wasn't experiencing the problems they mentioned (\u003cem\u003eat least in my local environment\u003c/em\u003e). The issues came when I actually pushed up code using this library to a staging environment and I noticed the PDFs were no longer generating.\u003c/p\u003e\n\u003cp\u003eI was able to remedy this by installing in an alternative way:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003esudo apt-get remove --purge wkhtmltopdf\nwget https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-1/wkhtmltox_0.12.6-1.bionic_amd64.deb\nsudo dpkg -i wkhtmltox_0.12.6-1.bionic_amd64.deb\nrm wkhtmltox_0.12.6-1.bionic_amd64.deb\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis isn't a big deal, but managing this dependency could get tedious if your architecture has multiple servers that need installed with different Linux distributions.\u003c/p\u003e\n\u003cp\u003ePutting this binary into an AWS Lambda Layer can help solve this by having a single point of installation and management.\u003c/p\u003e\n\u003ch2\u003eDownloading the \u003ccode\u003ewkhtmltopdf\u003c/code\u003e binary\u003c/h2\u003e\n\u003cp\u003eThe \u003ccode\u003ewkhtmltopdf\u003c/code\u003e site actually lists using this library with AWS Lambda as a \u003ca href=\"https://wkhtmltopdf.org/downloads.html#how-do-i-use-it-in-aws-lambda\"\u003eFAQ\u003c/a\u003e and gives the following response to this question:\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e\"All files required for lambda layer are packed in one zip archive (Amazon Linux 2 / lambda zip)\"\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eYou can download the binary on the releases page under the \u003ca href=\"https://wkhtmltopdf.org/downloads.html#stable\"\u003eStable releases\u003c/a\u003e. You'll see an entry under \u003ccode\u003eAmazon Linux\u003c/code\u003e with \u003ccode\u003elambda zip\u003c/code\u003e as the architecture.\u003c/p\u003e\n\u003cp\u003eOr, you can click \u003ca href=\"https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-4/wkhtmltox-0.12.6-4.amazonlinux2_lambda.zip\"\u003ehere\u003c/a\u003e (I likely won't update this link, so probably best to go directly to the release page).\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eRandom note:\u003c/em\u003e If you need more fonts for future usage, I've found that \u003ca href=\"https://github.com/brandonlim-hs/fonts-aws-lambda-layer\"\u003ethis is a good resource\u003c/a\u003e. You may need to include one of these fonts as a layer in your lambda function (via ARN) if your function has issues in the beginning.\u003c/p\u003e\n\u003ch2\u003eCreating the AWS Lambda layers\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html\"\u003eAWS Lambda layers\u003c/a\u003e allow us to add in \"layers\" of dependencies for our functions. An alternative to this is uploading your lambda function as a deployment package or using AWS SAM (Serverless Application Model), but that is out of the scope of this post.\u003c/p\u003e\n\u003ch3\u003e\u003ccode\u003ewkhtmltopdf\u003c/code\u003e\u003c/h3\u003e\n\u003cp\u003eNow that we have the zip file downloaded, let's add our file as a layer in the \u003ca href=\"https://us-east-2.console.aws.amazon.com/console/home?region=us-east-2\"\u003eAWS Management Console\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eGo to the \u003ca href=\"https://us-east-2.console.aws.amazon.com/lambda/home?region=us-east-2#/layers\"\u003eLayers section\u003c/a\u003e on the AWS Lambda page and click \u003ccode\u003eCreate layer\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eThen, add the following Layer configuration.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/converting-html-to-pdf/layer-configuration.jpg\" alt=\"AWS Lambda layer configuration {priority}{680x488}\"\u003e\u003c/p\u003e\n\u003cp\u003eNotice that we don't add a runtime here, this is intentional since our layer is a binary.\u003c/p\u003e\n\u003cp\u003eClick Create and take note of your new layer's Version ARN as we are about to use it to add to our function.\u003c/p\u003e\n\u003cp\u003eNow we're set up to create our function!\u003c/p\u003e\n\u003ch2\u003eWriting the AWS Lambda function\u003c/h2\u003e\n\u003cp\u003eNavigate to the \u003ca href=\"https://us-east-2.console.aws.amazon.com/lambda/home?region=us-east-2#/functions\"\u003eFunctions page\u003c/a\u003e within the AWS Lambda service and click \u003ccode\u003eCreate function\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eSelect \u003ccode\u003eAuthor from scratch\u003c/code\u003e, and add the following configuration.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/converting-html-to-pdf/function-configuration.jpg\" alt=\"AWS Lambda function configuration {1004x475}\"\u003e\u003c/p\u003e\n\u003cp\u003eYou can ignore the \u003ccode\u003eAdvanced settings\u003c/code\u003e for our use case.\u003c/p\u003e\n\u003cp\u003eOnce the function is created, we have just a few configuration additions to make.\u003c/p\u003e\n\u003ch3\u003eAdding the layer to our Lambda function\u003c/h3\u003e\n\u003cp\u003eNow that our function is created, the first thing we want to do is add our \u003ccode\u003ewkhtmltopdf\u003c/code\u003e layer.\u003c/p\u003e\n\u003cp\u003eAt the top of the Function Overview panel, click the \u003ccode\u003eLayers\u003c/code\u003e button right below your function name. This will bring you down to the layers section. Now click Add a layer.\u003c/p\u003e\n\u003cp\u003eClick on \u003ccode\u003eSpecify an ARN\u003c/code\u003e and copy your Layer Version ARN from earlier.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/converting-html-to-pdf/add-layer.jpg\" alt=\"AWS Lambda add layer {680x316}\"\u003e\u003c/p\u003e\n\u003cp\u003eThe reason why we need to specify our layer by ARN is because we didn't define a runtime above.\u003c/p\u003e\n\u003ch3\u003eAdd permission to access your S3 bucket\u003c/h3\u003e\n\u003cp\u003eOne final function configuration that we need to add is permission for our function to access Amazon S3.  To do this, navigate to the Configuration tab below your Function Overview.\u003c/p\u003e\n\u003cp\u003eUnder Configuration, go to the Permissions section. Here, you will see your generated Execution Role. Click this link to go to the IAM Console.\u003c/p\u003e\n\u003cp\u003eFrom here, click Attach policies, and add the \u003cstrong\u003eAmazonS3FullAccess\u003c/strong\u003e policy like so\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/converting-html-to-pdf/iam-policy.jpg\" alt=\"AWS Lambda IAM policy {1004x461}\"\u003e\u003c/p\u003e\n\u003cp\u003eNow that our function is configured, we can dive into the actual requirements and code!\u003c/p\u003e\n\u003ch3\u003eRequirements\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eAllow passing either an S3 file key or an HTML string\u003c/li\u003e\n\u003cli\u003eReturn a file key for the generated PDF\u003c/li\u003e\n\u003cli\u003eAccept a small set of options for the \u003ccode\u003ewkhtmltopdf\u003c/code\u003e command\n\u003cul\u003e\n\u003cli\u003eA full man page can be found \u003ca href=\"https://wkhtmltopdf.org/usage/wkhtmltopdf.txt\"\u003ehere\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eMost of the ones we'd want anyways are the default (i.e. \u003ccode\u003e--images\u003c/code\u003e, \u003ccode\u003e--enable-external-links\u003c/code\u003e, etc.)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eLet's allow the user to pass the following options\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e--orientation \u0026#x3C;orientation\u003e\u003c/code\u003e - the common page orientation for the PDF file.\n\u003cul\u003e\n\u003cli\u003eValid values are \u003ccode\u003eLandscape\u003c/code\u003e or \u003ccode\u003ePortrait\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e--title \u0026#x3C;text\u003e\u003c/code\u003e - the title of the generated file.\u003c/li\u003e\n\u003cli\u003eThe margins of the file\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e--margin-bottom \u0026#x3C;unitreal\u003e\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e--margin-left \u0026#x3C;unitreal\u003e\u003c/code\u003e (default is 10mm)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e--margin-right \u0026#x3C;unitreal\u003e\u003c/code\u003e  (default is 10mm)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e--margin-top \u0026#x3C;unitreal\u003e\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eAssumptions\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eThe HTML string or file will be valid and will include the necessary tags (\u003ccode\u003e\u0026#x3C;!DOCTYPE html\u003e\u003c/code\u003e, \u003ccode\u003e\u0026#x3C;html\u003e\u003c/code\u003e, \u003ccode\u003e\u0026#x3C;head\u003e\u003c/code\u003e, \u003ccode\u003e\u0026#x3C;body\u003e\u003c/code\u003e)\u003c/li\u003e\n\u003cli\u003eThe event payload will contain all valid values (S3 bucket name, file key, \u003ccode\u003ewkhtmltopdf\u003c/code\u003e options etc.)\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3\u003eThe function code\u003c/h3\u003e\n\u003cp\u003eBy default, you will see the following handler.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003edef lambda_handler(event, context):\n    # TODO implement\n    return {\n        'statusCode': 200,\n        'body': json.dumps('Hello from Lambda!')\n    }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is the code that will be executed when your function is called. We'll come back to this in a bit.\u003c/p\u003e\n\u003ch4\u003eThe imports\u003c/h4\u003e\n\u003cp\u003eFirst, let's go ahead and import all of the Python libraries that we'll need and set up some basic tools like the \u003ccode\u003eS3 client\u003c/code\u003e and our \u003ccode\u003elogger\u003c/code\u003e.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003efrom datetime import datetime\nimport json\nimport logging\nimport os\nimport subprocess\nfrom typing import Optional\n\nimport boto3\nfrom botocore.exceptions import ClientError\n\n\n# Set up logging\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\n# Get the s3 client\ns3 = boto3.client('s3')\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow based upon our requirements, we'll need helper functions to\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eDownload an HTML file from S3\u003c/li\u003e\n\u003cli\u003eUpload a file to S3\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eLet's start with those, and then we'll return to our lambda handler.\u003c/p\u003e\n\u003ch4\u003eDownloading/uploading the file\u003c/h4\u003e\n\u003cp\u003e\u003ca href=\"https://boto3.amazonaws.com/v1/documentation/api/latest/index.html\"\u003e\u003ccode\u003eboto3\u003c/code\u003e\u003c/a\u003e makes it really easy to interact with S3.  Using \u003ccode\u003eboto3\u003c/code\u003e, we can add the following helper functions.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003edef download_s3_file(bucket: str, file_key: str) -\u003e str:\n    \"\"\"Downloads a file from s3 to `/tmp/[File Key]`.\n    \n    Args:\n        bucket (str): Name of the bucket where the file lives.\n        file_key (str): The file key of the file in the bucket.\n\n    Returns:\n        The local file name as a string.\n    \"\"\"\n    local_filename = f'/tmp/{file_key}'\n    s3.download_file(Bucket=bucket, Key=file_key, Filename=local_filename)\n    logger.info('Downloaded HTML file to %s' % local_filename)\n\n    return local_filename\n    \n    \ndef upload_file_to_s3(bucket: str, filename: str) -\u003e Optional[str]:\n    \"\"\"Uploads the generated PDF to s3.\n    \n    Args:\n        bucket (str): Name of the s3 bucket to upload the PDF to.\n        filename (str): Location of the file to upload to s3.\n        \n    Returns:\n        The file key of the file in s3 if the upload was successful.\n        If the upload failed, then `None` will be returned.\n    \"\"\"\n    file_key = None\n    try:\n        file_key = filename.replace('/tmp/', '')\n        s3.upload_file(Filename=filename, Bucket=bucket, Key=file_key)\n        logger.info('Successfully uploaded the PDF to %s as %s'\n                    % (bucket, file_key))\n    except ClientError as e:\n        logger.error('Failed to upload file to s3.')\n        logger.error(e)\n        file_key = None\n        \n    return file_key\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4\u003eParsing the event\u003c/h4\u003e\n\u003cp\u003eOne thing we haven't talked about yet is the data that we'll need to pass our function.\u003c/p\u003e\n\u003cp\u003eLet's define our JSON event schema as the following.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e{\n    \"bucket\": \"\u0026#x3C;Name of the bucket where the file is stored currently and will be stored after processing\u003e [Required]\",\n    \"file_key\": \"\u0026#x3C;File key where the file is store in S3\u003e [Required if `html_string` is not defined]\",\n    \"html_string\": \"\u0026#x3C;HTML string to convert to a PDF\u003e [Required if `file_key` is not defined]\",\n    \"wkhtmltopdf_options\": {\n        \"orientation\": \"\u0026#x3C;`landscape` or `portrait`\u003e [Optional: Default is `portrait`]\",\n        \"title\": \"\u0026#x3C;Title of the PDF\u003e [Optional]\",\n        \"margin\": \"\u0026#x3C;Margin of the PDF (same format as css [\u0026#x3C;top\u003e \u0026#x3C;right\u003e \u0026#x3C;bottom\u003e \u0026#x3C;left\u003e] (all must be included)).\u003e [Optional]\"\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003ewkhtmltopdf_options\u003c/code\u003e is an optional object. If the included options are not valid, they will not be included.\u003c/p\u003e\n\u003cp\u003eWe can access all of the data passed to our function from the \u003ccode\u003eevent\u003c/code\u003e parameter in the \u003ccode\u003elambda_handler\u003c/code\u003e function.\u003c/p\u003e\n\u003cp\u003eNow, let's jump back to the \u003ccode\u003elambda_handler\u003c/code\u003e function and add some code to pull out the data from our event and put together the remaining pieces of actually calling the \u003ccode\u003ewkhtmltopdf\u003c/code\u003e executable to finish our lambda function.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003edef lambda_handler(event, context):\n    logger.info(event)\n\n    # bucket is always required\n    try:\n        bucket = event['bucket']\n    except KeyError:\n        error_message = 'Missing required \"bucket\" parameter from request payload.'\n        logger.error(error_message)\n        return {\n            'status': 400,\n            'body': json.dumps(error_message),\n        }\n\n    # html_string and file_key are conditionally required, so let's try to get both\n    try:\n        file_key = event['file_key']\n    except KeyError:\n        file_key = None\n\n    try:\n        html_string = event['html_string']\n    except KeyError:\n        html_string = None\n\n    if file_key is None and html_string is None:\n        error_message = (\n            'Missing both a \"file_key\" and \"html_string\" '\n            'from request payload. One of these must be '\n            'included.'\n        )\n        logger.error(error_message)\n        return {\n            'status': 400,\n            'body': json.dumps(error_message),\n        }\n\n    # Now we can check for the option wkhtmltopdf_options and map them to values\n    # Again, part of our assumptions are that these are valid\n    wkhtmltopdf_options = {}\n    if 'wkhtmltopdf_options' in event:\n        # Margin is \u0026#x3C;top\u003e \u0026#x3C;right\u003e \u0026#x3C;bottom\u003e \u0026#x3C;left\u003e\n        if 'margin' in event['wkhtmltopdf_options']:\n            margins = event['wkhtmltopdf_options']['margin'].split(' ')\n            if len(margins) == 4:\n                wkhtmltopdf_options['margin-top'] = margins[0]\n                wkhtmltopdf_options['margin-right'] = margins[1]\n                wkhtmltopdf_options['margin-bottom'] = margins[2]\n                wkhtmltopdf_options['margin-left'] = margins[3]\n\n        if 'orientation' in event['wkhtmltopdf_options']:\n            wkhtmltopdf_options['orientation'] = 'portrait' \\\n                if event['wkhtmltopdf_options']['orientation'].lower() not in ['portrait', 'landscape'] \\\n                else event['wkhtmltopdf_options']['orientation'].lower()\n\n        if 'title' in event['wkhtmltopdf_options']:\n            wkhtmltopdf_options['title'] = event['wkhtmltopdf_options']['title']\n\n    # If we got a file_key in the request, let's download our file\n    # If not, we'll write the HTML string to a file\n    if file_key is not None:\n        local_filename = download_s3_file(bucket, file_key)\n    else:\n        timestamp = str(datetime.now()).replace('.', '').replace(' ', '_')\n        local_filename = f'/tmp/{timestamp}-html-string.html'\n\n        # Delete any existing files with that name\n        try:\n            os.unlink(local_filename)\n        except FileNotFoundError:\n            pass\n\n        with open(local_filename, 'w') as f:\n            f.write(html_string)\n\n    # Now we can create our command string to execute and upload the result to s3\n    command = 'wkhtmltopdf  --load-error-handling ignore'  # ignore unecessary errors\n    for key, value in wkhtmltopdf_options.items():\n        if key == 'title':\n            value = f'\"{value}\"'\n        command += ' --{0} {1}'.format(key, value)\n    command += ' {0} {1}'.format(local_filename, local_filename.replace('.html', '.pdf'))\n\n    # Important! Remember, we said that we are assuming we're accepting valid HTML\n    # this should always be checked to avoid allowing any string to be executed\n    # from this command. The reason we use shell=True here is because our title\n    # can be multiple words.\n    subprocess.run(command, shell=True)\n    logger.info('Successfully generated the PDF.')\n    file_key = upload_file_to_s3(bucket, local_filename.replace('.html', '.pdf'))\n\n    if file_key is None:\n        error_message = (\n            'Failed to generate PDF from the given HTML file.'\n            ' Please check to make sure the file is valid HTML.'\n        )\n        logger.error(error_message)\n        return {\n            'status': 400,\n            'body': json.dumps(error_message),\n        }\n\n    return {\n        'status': 200,\n        'file_key': file_key,\n    }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow you can go to the \u003cstrong\u003eTest\u003c/strong\u003e tab and create the following test event (change your bucket name as necessary)\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e{\n    \"bucket\": \"bucket-for-articles\",\n    \"html_string\": \"\u0026#x3C;!DOCTYPE html\u003e\u0026#x3C;html\u003e\u0026#x3C;head\u003e\u0026#x3C;/head\u003e\u0026#x3C;body\u003eThis is an example of a simple HTML page.\u0026#x3C;/body\u003e\u0026#x3C;/html\u003e\",\n    \"wkhtmltopdf_options\": {\n        \"orientation\": \"portrait\",\n        \"title\": \"Test PDF Generation\",\n        \"margin\": \"10mm 10mm 10mm 10mm\"\n    }\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou should get a return event with a \u003ccode\u003estatus\u003c/code\u003e of \u003ccode\u003e200\u003c/code\u003e, and a \u003ccode\u003efile_key\u003c/code\u003e of your converted file, thus achieving our goal! üéâ\u003c/p\u003e\n\u003chr\u003e\n","markdown":"\n## tl;dr\n\n### Goal\n_To set up an easy to call HTML to PDF converter as an AWS Lambda function._\n\n### Process Overview\n1. **Downloading the `wkhtmltopdf` binary**\n2. **Creating the AWS Lambda layer(s) and configuring our function**\n3. **Writing the AWS Lambda function**\n    - We will use Python's [`subprocess` module](https://docs.python.org/3/library/subprocess.html) to call the `wkhtmltopdf` command\n    - For more in-depth Python focused usage, also check out [pdfkit](https://pypi.org/project/pdfkit/)\n\n### Prerequisites\nThis article assumes access to an AWS account (free-tier is acceptable) and basic knowledge of AWS Lambda/S3 and Python.\n\n### Functional Requirements\n\n1. Allow passing either an S3 file key or an HTML string\n2. Return a file key for the generated PDF\n3. Accept a small set of options for the `wkhtmltopdf` command\n    - A full man page can be found [here](https://wkhtmltopdf.org/usage/wkhtmltopdf.txt)\n    - Most of the ones we'd want anyways are the default (i.e. `--images`, `--enable-external-links`, etc.)\n\nFunctionality for the following options\n- `--orientation \u003corientation\u003e`\n- `--title \u003ctext\u003e`\n- `--margin-bottom \u003cunitreal\u003e`\n- `--margin-left \u003cunitreal\u003e`\n- `--margin-right \u003cunitreal\u003e`\n- `--margin-top \u003cunitreal\u003e`\n\n### Assumptions\n\n1. The HTML string or file will be valid and will include the necessary tags (`\u003c!DOCTYPE html\u003e`, `\u003chtml\u003e`, `\u003chead\u003e`, `\u003cbody\u003e`). **It is very important that you check validity of this HTML prior to calling this function if you ever use something similar in production. It may be best to only accept S3 file keys instead of HTML strings, but this is simply to show our functions possibilities or be used as an internal tool.**\n2. The event payload will contain all valid values (S3 bucket name, file key, `wkhtmltopdf` options etc.)\n\n### Notes\nThis article will use `us-east-2` for the AWS region, changing this shouldn't effect functionality, just the links within the article.\n\nA better way to do this is through [AWS Serverless Application Model (SAM)](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html), but this is more tailored for those looking for the basic setup through the AWS Management Console.\n\n---\nA common task I've found myself undertaking recently is programmatically converting an HTML file/string to an embedded and stylized PDF file.\n\nAn example use case for this might be exporting a self-managed customer invoice or generating a daily report from an existing HTML template. For those who have used template languages before, you can probably imagine the usefulness of a function like this in combination with [Jinja](https://jinja.palletsprojects.com/en/2.11.x/) or template rendering engines commonly found in Web Frameworks (like [Django](https://www.djangoproject.com/)).\n\nAfter doing some research on third party libraries that could simplify our goal, I decided to use [`wkhtmltopdf`](https://wkhtmltopdf.org/).\n\n`wkhtmltopdf` is an open-source command line tool that enables you to easy convert an HTML file to a PDF file. This is exactly what we're looking for. We will call the `wkhtmltopdf` command using the [`subprocess`](https://docs.python.org/3/library/subprocess.html) Python library. For more in-depth Python usage, you can check out [pdfkit](https://pypi.org/project/pdfkit/).\n\nLet's dive into it.\n\n---\n\n## Why AWS Lambda?\n[AWS Lambda](https://aws.amazon.com/lambda/) provides serverless computing functions where you don't need to manage any servers or containers, you can simply call your function synchronously or asynchronously, and it will be executed and scaled automatically.\n\nLambda has a ton of use cases and is something I have personally used many times and am a big fan of.\n\n_For our goal, AWS Lambda is a powerful tool for the following reasons_\n- It allows us to offload processing away from the server\n    - This is more of a general benefit, we won't actually be calling this function from a running server\n    - These calls will also be scaled automatically\n- Our dependencies, specifically the `wkhtmltopdf` binary, can be handled well through [AWS Lambda layers](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)\n    - This helps to avoid dealing with different Linux distributions or multiple installation locations\n\n**Below is an explanation of why handling the dependencies through layers will avoid issues. For continued instruction, you can skip to the next section.**\n\n### Issues with downloading the binary\nWhen I was first using this library, I was also using [`pdfkit`](https://pypi.org/project/pdfkit/) to drive this interaction.  At the top of the installation instructions, you can see the following warning:\n\n\u003cp style=\"background-color: orange; padding: 7px 20px; text-align: center; border-radius: 6px;\"\u003e\n\u003ci\u003e\"\u003cb\u003eWarning!\u003c/b\u003e\u0026nbsp;Version in debian/ubuntu repos have reduced functionality (because it compiled without the wkhtmltopdf QT patches), such as adding outlines, headers, footers, TOC etc. To use this options you should install static binary from wkhtmltopdf site\"\u003c/i\u003e\n\u003c/p\u003e\n\nWhen I first installed `wkhtmltopdf`, I didn't heed the warning and just ran the following:\n```bash\nsudo apt-get install wkhtmltopdf\n```\n\nOn initial inspection, I wasn't experiencing the problems they mentioned (_at least in my local environment_). The issues came when I actually pushed up code using this library to a staging environment and I noticed the PDFs were no longer generating.\n\nI was able to remedy this by installing in an alternative way:\n```bash\nsudo apt-get remove --purge wkhtmltopdf\nwget https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-1/wkhtmltox_0.12.6-1.bionic_amd64.deb\nsudo dpkg -i wkhtmltox_0.12.6-1.bionic_amd64.deb\nrm wkhtmltox_0.12.6-1.bionic_amd64.deb\n```\n\nThis isn't a big deal, but managing this dependency could get tedious if your architecture has multiple servers that need installed with different Linux distributions.\n\nPutting this binary into an AWS Lambda Layer can help solve this by having a single point of installation and management.\n\n## Downloading the `wkhtmltopdf` binary\nThe `wkhtmltopdf` site actually lists using this library with AWS Lambda as a [FAQ](https://wkhtmltopdf.org/downloads.html#how-do-i-use-it-in-aws-lambda) and gives the following response to this question:\n\n_\"All files required for lambda layer are packed in one zip archive (Amazon Linux 2 / lambda zip)\"_\n\nYou can download the binary on the releases page under the [Stable releases](https://wkhtmltopdf.org/downloads.html#stable). You'll see an entry under `Amazon Linux` with `lambda zip` as the architecture.\n\nOr, you can click [here](https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-4/wkhtmltox-0.12.6-4.amazonlinux2_lambda.zip) (I likely won't update this link, so probably best to go directly to the release page).\n\n_Random note:_ If you need more fonts for future usage, I've found that [this is a good resource](https://github.com/brandonlim-hs/fonts-aws-lambda-layer). You may need to include one of these fonts as a layer in your lambda function (via ARN) if your function has issues in the beginning.\n\n## Creating the AWS Lambda layers\n\n[AWS Lambda layers](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) allow us to add in \"layers\" of dependencies for our functions. An alternative to this is uploading your lambda function as a deployment package or using AWS SAM (Serverless Application Model), but that is out of the scope of this post.\n\n### `wkhtmltopdf`\nNow that we have the zip file downloaded, let's add our file as a layer in the [AWS Management Console](https://us-east-2.console.aws.amazon.com/console/home?region=us-east-2).\n\nGo to the [Layers section](https://us-east-2.console.aws.amazon.com/lambda/home?region=us-east-2#/layers) on the AWS Lambda page and click `Create layer`.\n\nThen, add the following Layer configuration.\n\n![AWS Lambda layer configuration {priority}{680x488}](/images/converting-html-to-pdf/layer-configuration.jpg)\n\nNotice that we don't add a runtime here, this is intentional since our layer is a binary.\n\nClick Create and take note of your new layer's Version ARN as we are about to use it to add to our function.\n\nNow we're set up to create our function!\n\n\n## Writing the AWS Lambda function\nNavigate to the [Functions page](https://us-east-2.console.aws.amazon.com/lambda/home?region=us-east-2#/functions) within the AWS Lambda service and click `Create function`.\n\nSelect `Author from scratch`, and add the following configuration.\n\n![AWS Lambda function configuration {1004x475}](/images/converting-html-to-pdf/function-configuration.jpg)\n\nYou can ignore the `Advanced settings` for our use case.\n\nOnce the function is created, we have just a few configuration additions to make.\n\n### Adding the layer to our Lambda function\n\nNow that our function is created, the first thing we want to do is add our `wkhtmltopdf` layer.\n\nAt the top of the Function Overview panel, click the `Layers` button right below your function name. This will bring you down to the layers section. Now click Add a layer.\n\nClick on `Specify an ARN` and copy your Layer Version ARN from earlier.\n\n![AWS Lambda add layer {680x316}](/images/converting-html-to-pdf/add-layer.jpg)\n\nThe reason why we need to specify our layer by ARN is because we didn't define a runtime above.\n\n\u003cp style=\"background-color: #9bc2cf; padding: 7px 20px; text-align: center; border-radius: 6px;\"\u003e\n\u003cb\u003eImportant!\u003c/b\u003e If your function generates a PDF with a bunch of black squares, this is likely because there is no font configuration within Lambda. To solve this, you can go to [this link](https://github.com/brandonlim-hs/fonts-aws-lambda-layer\") that I mentioned earlier, and copy one of the AWS Linux Fonts ARNs for your region (or build from scratch), add the environment variable in the README, and repeat these steps to add a font layer.\n\u003c/p\u003e\n\n### Add permission to access your S3 bucket\n\nOne final function configuration that we need to add is permission for our function to access Amazon S3.  To do this, navigate to the Configuration tab below your Function Overview.\n\nUnder Configuration, go to the Permissions section. Here, you will see your generated Execution Role. Click this link to go to the IAM Console.\n\nFrom here, click Attach policies, and add the **AmazonS3FullAccess** policy like so\n\n![AWS Lambda IAM policy {1004x461}](/images/converting-html-to-pdf/iam-policy.jpg)\n\nNow that our function is configured, we can dive into the actual requirements and code!\n\n### Requirements\n\n1. Allow passing either an S3 file key or an HTML string\n2. Return a file key for the generated PDF\n3. Accept a small set of options for the `wkhtmltopdf` command\n    - A full man page can be found [here](https://wkhtmltopdf.org/usage/wkhtmltopdf.txt)\n    - Most of the ones we'd want anyways are the default (i.e. `--images`, `--enable-external-links`, etc.)\n\nLet's allow the user to pass the following options\n- `--orientation \u003corientation\u003e` - the common page orientation for the PDF file.\n    - Valid values are `Landscape` or `Portrait`\n- `--title \u003ctext\u003e` - the title of the generated file.\n- The margins of the file\n    - `--margin-bottom \u003cunitreal\u003e`\n    - `--margin-left \u003cunitreal\u003e` (default is 10mm)\n    - `--margin-right \u003cunitreal\u003e`  (default is 10mm)\n    - `--margin-top \u003cunitreal\u003e`\n\n### Assumptions\n\n1. The HTML string or file will be valid and will include the necessary tags (`\u003c!DOCTYPE html\u003e`, `\u003chtml\u003e`, `\u003chead\u003e`, `\u003cbody\u003e`)\n2. The event payload will contain all valid values (S3 bucket name, file key, `wkhtmltopdf` options etc.)\n\n### The function code\nBy default, you will see the following handler.\n```python\ndef lambda_handler(event, context):\n    # TODO implement\n    return {\n        'statusCode': 200,\n        'body': json.dumps('Hello from Lambda!')\n    }\n```\nThis is the code that will be executed when your function is called. We'll come back to this in a bit.\n\n#### The imports\nFirst, let's go ahead and import all of the Python libraries that we'll need and set up some basic tools like the `S3 client` and our `logger`.\n```python\nfrom datetime import datetime\nimport json\nimport logging\nimport os\nimport subprocess\nfrom typing import Optional\n\nimport boto3\nfrom botocore.exceptions import ClientError\n\n\n# Set up logging\nlogger = logging.getLogger()\nlogger.setLevel(logging.INFO)\n\n# Get the s3 client\ns3 = boto3.client('s3')\n```\n\nNow based upon our requirements, we'll need helper functions to\n1. Download an HTML file from S3\n2. Upload a file to S3\n\nLet's start with those, and then we'll return to our lambda handler.\n\n#### Downloading/uploading the file\n[`boto3`](https://boto3.amazonaws.com/v1/documentation/api/latest/index.html) makes it really easy to interact with S3.  Using `boto3`, we can add the following helper functions.\n\n```python\ndef download_s3_file(bucket: str, file_key: str) -\u003e str:\n    \"\"\"Downloads a file from s3 to `/tmp/[File Key]`.\n    \n    Args:\n        bucket (str): Name of the bucket where the file lives.\n        file_key (str): The file key of the file in the bucket.\n\n    Returns:\n        The local file name as a string.\n    \"\"\"\n    local_filename = f'/tmp/{file_key}'\n    s3.download_file(Bucket=bucket, Key=file_key, Filename=local_filename)\n    logger.info('Downloaded HTML file to %s' % local_filename)\n\n    return local_filename\n    \n    \ndef upload_file_to_s3(bucket: str, filename: str) -\u003e Optional[str]:\n    \"\"\"Uploads the generated PDF to s3.\n    \n    Args:\n        bucket (str): Name of the s3 bucket to upload the PDF to.\n        filename (str): Location of the file to upload to s3.\n        \n    Returns:\n        The file key of the file in s3 if the upload was successful.\n        If the upload failed, then `None` will be returned.\n    \"\"\"\n    file_key = None\n    try:\n        file_key = filename.replace('/tmp/', '')\n        s3.upload_file(Filename=filename, Bucket=bucket, Key=file_key)\n        logger.info('Successfully uploaded the PDF to %s as %s'\n                    % (bucket, file_key))\n    except ClientError as e:\n        logger.error('Failed to upload file to s3.')\n        logger.error(e)\n        file_key = None\n        \n    return file_key\n```\n\n#### Parsing the event\nOne thing we haven't talked about yet is the data that we'll need to pass our function.\n\nLet's define our JSON event schema as the following.\n```json\n{\n    \"bucket\": \"\u003cName of the bucket where the file is stored currently and will be stored after processing\u003e [Required]\",\n    \"file_key\": \"\u003cFile key where the file is store in S3\u003e [Required if `html_string` is not defined]\",\n    \"html_string\": \"\u003cHTML string to convert to a PDF\u003e [Required if `file_key` is not defined]\",\n    \"wkhtmltopdf_options\": {\n        \"orientation\": \"\u003c`landscape` or `portrait`\u003e [Optional: Default is `portrait`]\",\n        \"title\": \"\u003cTitle of the PDF\u003e [Optional]\",\n        \"margin\": \"\u003cMargin of the PDF (same format as css [\u003ctop\u003e \u003cright\u003e \u003cbottom\u003e \u003cleft\u003e] (all must be included)).\u003e [Optional]\"\n    }\n}\n```\n`wkhtmltopdf_options` is an optional object. If the included options are not valid, they will not be included.\n\nWe can access all of the data passed to our function from the `event` parameter in the `lambda_handler` function.\n\nNow, let's jump back to the `lambda_handler` function and add some code to pull out the data from our event and put together the remaining pieces of actually calling the `wkhtmltopdf` executable to finish our lambda function.\n\n```python\ndef lambda_handler(event, context):\n    logger.info(event)\n\n    # bucket is always required\n    try:\n        bucket = event['bucket']\n    except KeyError:\n        error_message = 'Missing required \"bucket\" parameter from request payload.'\n        logger.error(error_message)\n        return {\n            'status': 400,\n            'body': json.dumps(error_message),\n        }\n\n    # html_string and file_key are conditionally required, so let's try to get both\n    try:\n        file_key = event['file_key']\n    except KeyError:\n        file_key = None\n\n    try:\n        html_string = event['html_string']\n    except KeyError:\n        html_string = None\n\n    if file_key is None and html_string is None:\n        error_message = (\n            'Missing both a \"file_key\" and \"html_string\" '\n            'from request payload. One of these must be '\n            'included.'\n        )\n        logger.error(error_message)\n        return {\n            'status': 400,\n            'body': json.dumps(error_message),\n        }\n\n    # Now we can check for the option wkhtmltopdf_options and map them to values\n    # Again, part of our assumptions are that these are valid\n    wkhtmltopdf_options = {}\n    if 'wkhtmltopdf_options' in event:\n        # Margin is \u003ctop\u003e \u003cright\u003e \u003cbottom\u003e \u003cleft\u003e\n        if 'margin' in event['wkhtmltopdf_options']:\n            margins = event['wkhtmltopdf_options']['margin'].split(' ')\n            if len(margins) == 4:\n                wkhtmltopdf_options['margin-top'] = margins[0]\n                wkhtmltopdf_options['margin-right'] = margins[1]\n                wkhtmltopdf_options['margin-bottom'] = margins[2]\n                wkhtmltopdf_options['margin-left'] = margins[3]\n\n        if 'orientation' in event['wkhtmltopdf_options']:\n            wkhtmltopdf_options['orientation'] = 'portrait' \\\n                if event['wkhtmltopdf_options']['orientation'].lower() not in ['portrait', 'landscape'] \\\n                else event['wkhtmltopdf_options']['orientation'].lower()\n\n        if 'title' in event['wkhtmltopdf_options']:\n            wkhtmltopdf_options['title'] = event['wkhtmltopdf_options']['title']\n\n    # If we got a file_key in the request, let's download our file\n    # If not, we'll write the HTML string to a file\n    if file_key is not None:\n        local_filename = download_s3_file(bucket, file_key)\n    else:\n        timestamp = str(datetime.now()).replace('.', '').replace(' ', '_')\n        local_filename = f'/tmp/{timestamp}-html-string.html'\n\n        # Delete any existing files with that name\n        try:\n            os.unlink(local_filename)\n        except FileNotFoundError:\n            pass\n\n        with open(local_filename, 'w') as f:\n            f.write(html_string)\n\n    # Now we can create our command string to execute and upload the result to s3\n    command = 'wkhtmltopdf  --load-error-handling ignore'  # ignore unecessary errors\n    for key, value in wkhtmltopdf_options.items():\n        if key == 'title':\n            value = f'\"{value}\"'\n        command += ' --{0} {1}'.format(key, value)\n    command += ' {0} {1}'.format(local_filename, local_filename.replace('.html', '.pdf'))\n\n    # Important! Remember, we said that we are assuming we're accepting valid HTML\n    # this should always be checked to avoid allowing any string to be executed\n    # from this command. The reason we use shell=True here is because our title\n    # can be multiple words.\n    subprocess.run(command, shell=True)\n    logger.info('Successfully generated the PDF.')\n    file_key = upload_file_to_s3(bucket, local_filename.replace('.html', '.pdf'))\n\n    if file_key is None:\n        error_message = (\n            'Failed to generate PDF from the given HTML file.'\n            ' Please check to make sure the file is valid HTML.'\n        )\n        logger.error(error_message)\n        return {\n            'status': 400,\n            'body': json.dumps(error_message),\n        }\n\n    return {\n        'status': 200,\n        'file_key': file_key,\n    }\n```\n\nNow you can go to the **Test** tab and create the following test event (change your bucket name as necessary)\n```json\n{\n    \"bucket\": \"bucket-for-articles\",\n    \"html_string\": \"\u003c!DOCTYPE html\u003e\u003chtml\u003e\u003chead\u003e\u003c/head\u003e\u003cbody\u003eThis is an example of a simple HTML page.\u003c/body\u003e\u003c/html\u003e\",\n    \"wkhtmltopdf_options\": {\n        \"orientation\": \"portrait\",\n        \"title\": \"Test PDF Generation\",\n        \"margin\": \"10mm 10mm 10mm 10mm\"\n    }\n}\n```\n\nYou should get a return event with a `status` of `200`, and a `file_key` of your converted file, thus achieving our goal! üéâ\n\n---\n\n","title":"Converting HTML to a PDF using Python, AWS Lambda, and wkhtmltopdf","date":"2021-04-29","tags":["python","aws"],"description":"Building an AWS lambda function that uses Python and wkhtmltopdf to convert an HTML file to a PDF file."}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"converting-html-to-pdf"},"buildId":"YR03i7rb3JyT9k3rOsHHa","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>